#!/usr/bin/env bash
[ "${TRAVIS_PULL_REQUEST}" = "false" ] && [ "${TRAVIS_BRANCH}" = "master" ] && {
# Setup everything 
desc="$(git log -1 --pretty=%B)"
sudo apt-get update
sudo apt-get install busybox ruby-ronn build-essential devscripts lintian diff patch patchutils dpkg-dev
mkdir temp
gitsync() {
branch="${1}"
shift

git add -A
git commit -am "${*}"
git push origin ${branch}

}

git clone https://${GH_TOKEN}@github.com/danog/video-dl.git
cd video-dl
git config --global user.name "${GIT_NAME}"
git config --global user.email "${GIT_EMAIL}"
git config --global push.default simple
echo "$desc" | grep -q madebytravisci && exit 1
########################################
version=$(git describe --tags)

# Sync API
cd api
sed '/api[(][)]/,/beginning of common section/!d;/echo \"\$userinput/,/video-db\.txt/d' api.sh>script_api.sh
cat ../travis/last_api.sh >> script_api.sh
busybox ftpput -u $u2 -p $p2 $ftp api.sh script_api.sh
mv script_api.sh ..
sed '/\#\!\/bin\/bash/,/\# 1st part ends here/!d' video.sh>tmpvideo.sh
cat script_api.sh >>tmpvideo.sh
sed '/\# 2nd part starts here/,/exit \$\?/!d' video.sh>>tmpvideo.sh
mv tmpvideo.sh video.sh
rm script_api.sh
cp video.sh ../temp
cd ../temp
busybox ftpput -u $u1 -p $p1 $ftp video.sh
busybox ftpput -u $u1 -p $p1 $ftp rai.sh video.sh
busybox ftpput -u $u1 -p $p1 $ftp mediaset.sh video.sh
sed 's/#!\/bin\/bash/#!\/system\/xbin\/bash/' video.sh | sed 's/http:\/\/daniilgentili.magix.net\/video.sh/http:\/\/daniilgentili.magix.net\/android\/video.sh/' >videoa.sh
busybox ftpput -u $u1 -p $p1 $ftp android/video.sh videoa.sh
busybox ftpput -u $u1 -p $p1 $ftp ftp.magix-online.com android/rai.sh videoa.sh
busybox ftpput -u $u1 -p $p1 $ftp android/mediaset.sh videoa.sh

sed 's/http:\/\/daniilgentili.magix.net\/video.sh/http:\/\/daniilgentili.magix.net\/android\/video.sh/;s/wget/wget.exe/g;s/curl/curl.exe/g' video.sh >videow.sh
busybox ftpput -u $u1 -p $p1 $ftp win-native/video.sh videow.sh
busybox ftpput -u $u1 -p $p1 $ftp win-native/rai.sh videow.sh
busybox ftpput -u $u1 -p $p1 $ftp win-native/mediaset.sh videow.sh


sed -i 's/http:\/\/daniilgentili.magix.net\/video.sh/http:\/\/daniilgentili.magix.net\/win\/video.sh/' video.sh
busybox ftpput -u $u1 -p $p1 $ftp win/video.sh video.sh
busybox ftpput -u $u1 -p $p1 $ftp win/rai.sh video.sh
busybox ftpput -u $u1 -p $p1 $ftp win/mediaset.sh video.sh

cd ../video-dl

# Generate deb
git status | grep -q video.sh && {
cd debian/*/
ronn --roff ../../README-IT.md
ronn --roff ../../README.md
mv README-IT debian/video-dl-it.1
mv README debian/video-dl.1
cp ../../video.sh .
echo "debian/video-dl.1
debian/video-dl-it.1" > debian/video-dl.manpages
dch -v $version -r stable $desc 
dpkg-buildpackage -Zgzip
: "cd ../../temp
git clone https://${GH_TOKEN}@github.com/danog/repo.git
cd repo/debs
cp ../../../video-dl/debian/*.deb .
gitsync master Updated video-dl
cd ../../../video-dl"
}

# Generate website
rm -r ../temp/*
cd jekyll
rm _posts/*
cp ../README*.md _posts
bundle exec jekyll build
cp -a _site/* ../../temp
cd ../
gitsync master OK madebytravisci

# Upload everything
git checkout gh-pages
rm -rf *
cp -a ../temp/* .
touch .nojekyll

echo "branches:
  except:
    - gh-pages" > .travis.yml
gitsync gh-pages "Updated the website"

}
